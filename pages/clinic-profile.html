<!DOCTYPE html>
<html lang="en">

    <link rel="preload" href="../css/style.css" as="style">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="environment" content="development">
    <title id="pageTitle">Clinic Profile - CareGrid Healthcare Directory</title>
    <meta id="pageDescription" name="description" content="Find detailed information about healthcare clinics and providers. View services, ratings, contact details, and book appointments with trusted private healthcare providers.">
    <meta name="keywords" content="clinic profile, private healthcare, GP Manchester, dentist Leeds, healthcare provider, medical clinic, clinic details, book appointment">
    <link rel="canonical" href="https://www.caregrid.co.uk/clinic-profile.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta id="ogTitle" property="og:title" content="Clinic Profile - CareGrid Healthcare Directory">
    <meta id="ogDescription" property="og:description" content="Find detailed information about healthcare clinics and providers. View services, ratings, and book appointments.">
    <meta property="og:url" content="https://www.caregrid.co.uk/clinic-profile.html">
    <meta id="ogImage" property="og:image" content="https://www.caregrid.co.uk/og-image.svg">
    <meta property="og:site_name" content="CareGrid">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta id="twitterTitle" name="twitter:title" content="Clinic Profile - CareGrid Healthcare Directory">
    <meta id="twitterDescription" name="twitter:description" content="Find detailed information about healthcare clinics and providers. View services, ratings, and book appointments.">
    <meta id="twitterImage" name="twitter:image" content="https://www.caregrid.co.uk/og-image.svg">
    <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/ai-reception.css">
    <style>
        .hour-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .hour-row:last-child {
            border-bottom: none;
        }
        
        .clinic-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 16px;
        }
        
        .clinic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .clinic-image-container {
            position: relative;
            height: 150px;
            overflow: hidden;
        }
        
        .clinic-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .premium-badge-image {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .clinic-content {
            padding: 16px;
        }
        
        .clinic-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 4px 0;
            color: #333;
        }
        
        .clinic-type {
            color: #666;
            font-size: 0.9rem;
            margin: 0 0 8px 0;
        }
        
        .clinic-location {
            color: #888;
            font-size: 0.85rem;
            margin: 0 0 8px 0;
        }
        
        .clinic-rating {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stars {
            color: #ffc107;
            font-size: 0.9rem;
        }
        
        .rating-text {
             color: #666;
             font-size: 0.85rem;
         }
         
         /* Mobile Polish and Safe Area Support */
         body {
             padding-bottom: 88px;
             padding-bottom: calc(88px + env(safe-area-inset-bottom));
         }
         
         @supports (padding: max(0px)) {
             body {
                 padding-bottom: max(88px, env(safe-area-inset-bottom));
             }
         }
         
         /* Rating highlight row styling */
         .clinic-rating {
             margin: 12px 0 16px 0;
             padding: 8px 0;
             border-bottom: 1px solid rgba(0,0,0,0.1);
         }
         
         /* Empty state styling */
         .empty-state {
             background: #f8f9fa;
             border-radius: 12px;
             border: 2px dashed #dee2e6;
         }
         
         .empty-state:hover {
             border-color: #007bff;
             background: #f0f8ff;
         }
         
         .search-all-btn:hover {
             background: #0056b3 !important;
             transform: translateY(-1px);
             box-shadow: 0 4px 8px rgba(0,123,255,0.3);
         }
         
         /* Contact info loading states */
         .contact-item span:empty::after {
             content: 'Loading...';
             color: #999;
             font-style: italic;
         }
         
         /* Ensure buttons meet accessibility requirements */
         .contact-btn, .website-btn, .search-all-btn {
             min-height: 44px;
             min-width: 44px;
             display: inline-flex;
             align-items: center;
             justify-content: center;
             text-decoration: none;
         }
         
         /* Focus outlines for accessibility */
         .contact-btn:focus, 
         .website-btn:focus, 
         .search-all-btn:focus,
         .filter-option:focus {
             outline: 2px solid #007bff;
             outline-offset: 2px;
         }
         
         @media (max-width: 768px) {
             /* Additional mobile spacing */
             .clinic-profile-header {
                 padding-bottom: 20px;
             }
             
             .clinic-details {
                 padding-bottom: 20px;
             }
             
             .similar-clinics {
                 padding-bottom: 40px;
             }
             
             /* Ensure rating row is prominent on mobile */
             .clinic-rating {
                 font-size: 1.1rem;
                 margin: 16px 0 20px 0;
                 padding: 12px 0;
             }
             
             .clinic-rating .stars {
                 font-size: 1.2rem;
             }
         }
         
         .similar-clinics {
             padding: 60px 0;
             background: #f8f9fa;
         }
         
         .clinic-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
             gap: 24px;
             margin-top: 32px;
         }
         
         @media (max-width: 768px) {
             .clinic-grid {
                 grid-template-columns: 1fr;
                 gap: 16px;
             }
         }
         
         /* Status indicator styles */
         .status-open {
             color: #28a745 !important;
             font-weight: 600;
         }
         
         .status-closed {
             color: #dc3545 !important;
             font-weight: 600;
         }
         
         .status-opening-soon {
             color: #ffc107 !important;
             font-weight: 600;
         }
         
         /* Hero image styles */
         .clinic-hero-image {
             width: 100%;
             height: 250px;
             overflow: hidden;
             position: relative;
         }
         
         .hero-image-container {
             width: 100%;
             height: 100%;
             position: relative;
         }
         
         .hero-image {
             width: 100%;
             height: 100%;
             object-fit: cover;
         }
         
         .hero-overlay {
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
         }
         
         /* Improved visual hierarchy */
         .clinic-info .clinic-type {
             font-size: 0.9rem;
             color: #666;
             margin-bottom: 12px;
         }
         
         .clinic-info .clinic-address {
             font-size: 0.85rem;
             color: #888;
             margin-bottom: 16px;
         }
         
         .clinic-rating {
             background: #f0fdf4;
             border: 1px solid #bbf7d0;
             border-radius: 8px;
             padding: 8px 12px;
             display: inline-flex;
             align-items: center;
             gap: 8px;
             margin-bottom: 16px;
         }
         
         .clinic-rating .stars {
             color: #ffc107;
             font-size: 1rem;
             font-weight: 600;
         }
         
         .clinic-rating .rating-text {
             color: #15803d;
             font-size: 0.9rem;
             font-weight: 600;
         }
         
         /* Quick Actions spacing improvements */
         .action-buttons {
             display: flex;
             flex-direction: column;
             gap: 12px;
         }
         
         .action-btn {
             width: 100%;
             padding: 12px 16px;
             border-radius: 8px;
             font-weight: 600;
             text-decoration: none;
             text-align: center;
             transition: all 0.2s ease;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 8px;
             border: 2px solid transparent;
             cursor: pointer;
         }
         
         .action-btn.primary {
             background: #2A6EF3;
             color: white;
         }
         
         .action-btn.primary:hover {
             background: #1E5AD1;
             transform: translateY(-1px);
         }
         
         .action-btn.secondary {
             background: #f8f9fa;
             color: #2A6EF3;
             border-color: #e9ecef;
         }
         
         .action-btn.secondary:hover {
             background: #e9ecef;
             transform: translateY(-1px);
         }

         /* Mobile Sticky CTA Bar - matches requested implementation */
         .sticky-cta {
             display: none; /* Hidden by default */
         }
         
         @media (max-width: 600px){
             .clinic-profile-content{
                 padding-bottom: calc(110px + env(safe-area-inset-bottom, 0px));
             }
             .sticky-cta{
                 position: fixed; left:0; right:0; bottom:0;
                 background:#fff; display:flex; gap:10px;
                 padding:12px calc(12px + env(safe-area-inset-left,0px))
                         calc(12px + env(safe-area-inset-bottom,0px));
                 box-shadow:0 -4px 12px rgba(0,0,0,.1);
                 z-index:1000;
             }
             .sticky-cta .btn{ flex:1; min-height:48px; font-size:16px; text-align:center; }
         }

         /* Rating Highlight Row */
         .rating-row {
             margin: 8px 0 12px;
             background: #17a673; 
             color: #fff;
             border-radius: 10px; 
             padding: 10px 12px;
             font-weight: 600; 
             display: flex; 
             gap: 10px; 
             align-items: center;
         }
         
         .rating-row .stars { 
             filter: brightness(0) invert(1); 
         }
         
         .rating-row .rating-score { 
             font-size: 14px; 
         }

         /* Empty state for similar clinics */
         .empty {
             text-align: center;
             padding: 40px 20px;
             background: #f8f9fa;
             border-radius: 12px;
             margin-top: 20px;
         }

         .empty p {
             color: #6c757d;
             margin-bottom: 20px;
             font-size: 1.1rem;
         }

         .empty .btn {
             background: #2A6EF3;
             color: white;
             padding: 12px 24px;
             border: none;
             border-radius: 6px;
             text-decoration: none;
             display: inline-block;
             font-weight: 600;
             transition: background 0.3s ease;
         }

         .empty .btn:hover {
             background: #1E5AD1;
         }
         
         @media (max-width: 768px) {
             .clinic-hero-image {
                 height: 200px;
             }
         }
     </style>
     
     <!-- JSON-LD Schema for Clinic -->
     <script type="application/ld+json" id="clinicSchema">
     {
       "@context": "https://schema.org",
       "@type": "MedicalBusiness",
       "name": "Clinic Name",
       "description": "Healthcare clinic providing quality medical services",
       "url": "https://www.caregrid.co.uk/clinic-profile.html",
       "telephone": "",
       "address": {
         "@type": "PostalAddress",
         "streetAddress": "",
         "addressLocality": "",
         "addressRegion": "",
         "postalCode": "",
         "addressCountry": "GB"
       },
       "openingHours": [],
       "priceRange": "£",
       "aggregateRating": {
         "@type": "AggregateRating",
         "ratingValue": "0",
         "reviewCount": "0"
       },
       "image": "",
       "medicalSpecialty": [],
       "paymentAccepted": ["Cash", "Credit Card"],
       "currenciesAccepted": "GBP"
     }
     </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="" alt="CareGrid - Healthcare Directory Platform Logo" class="logo" id="navLogo">
                <span class="logo-text">CareGrid</span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li class="stakeholder-only"><a href="pricing.html" class="nav-link">Pricing</a></li>
                <li><a href="contact.html" class="nav-link">Contact</a></li>
                <li id="authNavItem"><a href="auth.html" class="nav-link">Sign In</a></li>
                <li id="userNavItem" style="display: none;">
                    <div class="user-menu">
                        <!-- User menu content populated by header.js -->
                    </div>
                </li>
                <li><a href="list-clinic.html" class="nav-link cta-nav">List Your Clinic</a></li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Clinic Hero Image -->
    <section class="clinic-hero-image">
        <div class="hero-image-container">
            <img src="" alt="Clinic Interior" id="clinicHeroImage" class="hero-image">
            <div class="hero-overlay">
                <div class="hero-gradient"></div>
            </div>
        </div>
    </section>

    <!-- Clinic Profile Header -->
    <section class="clinic-profile-header">
        <div class="container">
            <div class="profile-content">
                <div class="clinic-image-large">
                    <img src="" alt="Clinic" id="clinicImage">
                    <div class="image-overlay">
                        <div class="type-badge">
                            <i class="fas fa-stethoscope"></i>
                            <span id="overlayType">Loading...</span>
                        </div>
                        <div class="premium-badge-image" id="premiumBadge"><i class="fas fa-crown"></i> Premium</div>
                    </div>
                </div>
                <div class="clinic-info">
                    <h1 id="clinicName">Loading clinic information...</h1>
                    <div class="rating-row" id="ratingHighlight">
                        <span class="stars" id="clinicStarsHighlight">★★★★★</span>
                        <span class="rating-score" id="clinicRatingHighlight">4.7 • 0 reviews</span>
                    </div>
                    <p class="clinic-type" id="clinicType">Loading...</p>
                    <p class="clinic-address" id="clinicAddress">
                        <i class="fas fa-map-marker-alt"></i>
                        Loading address...
                    </p>
                    <!-- Inline CTAs removed - moved to Quick Actions and sticky bar -->
                </div>
            </div>
        </div>
    </section>

    <!-- Clinic Details -->
    <section class="clinic-details clinic-profile-content">
        <div class="container">
            <div class="details-grid">
                <div class="main-content">
                    <div class="section-card">
                        <h3>About This Clinic</h3>
                        <p id="clinicDescription">
                            Loading clinic information...
                        </p>
                    </div>

                    <div class="section-card">
                        <h3>Services Offered</h3>
                        <div class="services-grid" id="clinicServices">
                            <span class="service-tag">General Consultation</span>
                            <span class="service-tag">Health Screenings</span>
                            <span class="service-tag">Vaccinations</span>
                            <span class="service-tag">Minor Surgery</span>
                        </div>
                    </div>

                    <div class="section-card">
                        <h3>Opening Hours</h3>
                        <div class="hours-grid" id="openingHours">
                            <div class="hour-row">
                                <span>Monday - Friday</span>
                                <span>8:00 AM - 6:00 PM</span>
                            </div>
                            <div class="hour-row">
                                <span>Saturday</span>
                                <span>9:00 AM - 2:00 PM</span>
                            </div>
                            <div class="hour-row">
                                <span>Sunday</span>
                                <span>Closed</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="section-card">
                        <h3>Quick Actions</h3>
                        <div class="action-buttons">
                            <button class="action-btn ai-reception" onclick="AIReceptionService.initializeCall()">
                                <i class="fas fa-robot"></i>
                                AI Reception
                            </button>
                            <button class="action-btn primary">
                                <i class="fas fa-calendar"></i>
                                Book Appointment
                            </button>
                            <button class="action-btn secondary" id="directionsBtn">
                                <i class="fas fa-directions"></i>
                                Get Directions
                            </button>
                            <button class="action-btn secondary" id="websiteBtn">
                                <i class="fas fa-globe"></i>
                                Visit Website
                            </button>
                            <button class="action-btn secondary" onclick="shareClinic()">
                                <i class="fas fa-share"></i>
                                Share Clinic
                            </button>
                        </div>
                    </div>

                    <div class="section-card">
                        <h3>Contact Information</h3>
                        <div class="contact-info">
                            <div class="contact-item">
                                <i class="fas fa-phone"></i>
                                <span id="clinicPhone">Loading...</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <span id="clinicEmail">Loading...</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-clock"></i>
                                <span id="clinicStatus">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Similar Clinics -->
    <section class="similar-clinics clinic-profile-content" id="similar">
        <div class="container">
            <h2 class="section-title">Similar clinics nearby</h2>
            <div class="clinic-grid" id="similar-list">
                <!-- Similar clinics will be populated by JavaScript -->
            </div>
            <div id="similar-empty" class="empty" hidden>
                <p>No similar clinics found.</p>
                <a class="btn" href="/?near=this">Search all clinics</a>
            </div>
        </div>
    </section>

    <!-- Mobile Sticky Bottom Action Bar -->
    <div class="clinic-profile-bottom-bar">
        <button class="bottom-action-btn ai-reception" onclick="AIReceptionService.initializeCall()">
            <i class="fas fa-robot"></i>
            <span>AI Call</span>
        </button>
        <a href="tel:" class="bottom-action-btn call" id="bottomCallBtn">
            <i class="fas fa-phone"></i>
            Call
        </a>
        <a href="mailto:" class="bottom-action-btn email" id="bottomEmailBtn">
            <i class="fas fa-envelope"></i>
            Email
        </a>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>CareGrid</h4>
                    <p>Connecting you with quality healthcare providers across the UK.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="pricing.html">Pricing</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>For Clinics</h4>
                    <ul>
                        <li><a href="list-clinic.html">List Your Clinic</a></li>
                        <li><a href="#">Manage Listing</a></li>
                        <li><a href="#">Analytics</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 CareGrid. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Mobile Sticky CTA Bar -->
    <div class="sticky-cta">
        <a href="tel:" id="cta-call" class="btn">
            <i class="fas fa-phone"></i>
            Call
        </a>
        <a href="mailto:" id="cta-email" class="btn">
            <i class="fas fa-envelope"></i>
            Email
        </a>
    </div>

    <script>
        let currentClinic = null;
        
        // Load clinic data from URL parameters
        async function initializeClinicProfile() {
            const urlParams = new URLSearchParams(window.location.search);
            const clinicId = urlParams.get('id');
            
            if (clinicId) {
                // Show loading state
                showLoadingState();
                
                // Check if local data is available first for faster loading
                let clinic = null;
                if (window.clinicsData) {
                    clinic = window.clinicsData.find(c => c.id == clinicId);
                    if (clinic) {
                        console.log('Found clinic in local data:', clinic.name);
                        currentClinic = clinic;
                        updateClinicDisplay(clinic);
                        return; // Exit early with local data
                    }
                }
                
                // If no local data found, try API with timeout
                try {
                    console.log('Attempting to load clinic from API...');
                    
                    // Add timeout to API call to prevent hanging
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('API timeout')), 5000)
                    );
                    
                    const apiPromise = window.apiService.getClinicById(clinicId);
                    const response = await Promise.race([apiPromise, timeoutPromise]);
                    const apiClinic = response.data || response;
                    
                    if (apiClinic) {
                        console.log('Loaded clinic from API:', apiClinic.name);
                        currentClinic = apiClinic;
                        updateClinicDisplay(apiClinic);
                    } else {
                        console.log('Clinic not found for ID:', clinicId);
                        showErrorMessage('Clinic not found');
                    }
                } catch (error) {
                    console.error('Failed to load clinic data from API:', error);
                    
                    // Final fallback to local data if API fails
                    if (window.clinicsData) {
                        clinic = window.clinicsData.find(c => c.id == clinicId);
                        if (clinic) {
                            console.log('Using local data as fallback:', clinic.name);
                            currentClinic = clinic;
                            updateClinicDisplay(clinic);
                        } else {
                            console.log('Clinic not found in local data for ID:', clinicId);
                            showErrorMessage('Clinic not found');
                        }
                    } else {
                        console.error('No clinic data available');
                        showErrorMessage('Unable to load clinic information');
                    }
                }
            } else {
                console.log('Missing clinicId parameter');
                showErrorMessage('No clinic specified');
            }
        }
        
        function showLoadingState() {
            document.getElementById('clinicName').textContent = 'Loading clinic information...';
            document.getElementById('clinicType').textContent = 'Loading...';
            document.getElementById('clinicAddress').innerHTML = '<i class="fas fa-map-marker-alt"></i> Loading address...';
            document.getElementById('clinicPhone').textContent = 'Loading...';
            document.getElementById('clinicEmail').textContent = 'Loading...';
            document.getElementById('clinicStatus').textContent = 'Loading...';
            document.getElementById('overlayType').textContent = 'Loading...';
            document.getElementById('clinicDescription').textContent = 'Loading clinic information...';
            document.getElementById('clinicRatingHighlight').textContent = 'Loading reviews...';
            
            // Start timeout for contact info (Fix 4)
            setTimeout(() => {
                const phoneEl = document.getElementById('clinicPhone');
                const emailEl = document.getElementById('clinicEmail');
                
                if (phoneEl && phoneEl.textContent === 'Loading...') {
                    phoneEl.textContent = 'Not available';
                }
                
                if (emailEl && emailEl.textContent === 'Loading...') {
                    emailEl.textContent = 'Not available';
                }
            }, 2000); // 2 second timeout
        }
        
        function showErrorMessage(message) {
            document.getElementById('clinicName').textContent = message;
            document.getElementById('clinicType').textContent = '';
            document.getElementById('clinicAddress').innerHTML = '<i class="fas fa-map-marker-alt"></i> Address not available';
            document.getElementById('clinicPhone').textContent = 'Phone not available';
            document.getElementById('clinicEmail').textContent = 'Email not available';
            document.getElementById('clinicStatus').textContent = 'Status unknown';
            document.getElementById('overlayType').textContent = '';
            document.getElementById('clinicDescription').textContent = 'Please check the URL and try again.';
            
            // Hide rating highlight on error
            const ratingHighlight = document.getElementById('ratingHighlight');
            if (ratingHighlight) {
                ratingHighlight.style.display = 'none';
            }
            
            // Hide premium badge when there's an error
            const premiumBadge = document.getElementById('premiumBadge');
            if (premiumBadge) {
                premiumBadge.style.display = 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure initialization happens with proper error handling
            try {
                initializeClinicProfile();
            } catch (error) {
                console.error('Error during initialization:', error);
                // Fallback initialization in case of errors
                setTimeout(initializeClinicProfileFallback, 500);
            }
        });
        
        // Backup initialization function that works without complex dependencies
        function initializeClinicProfileFallback() {
            console.log('Running fallback initialization...');
            const urlParams = new URLSearchParams(window.location.search);
            const clinicId = urlParams.get('id');
            
            if (clinicId && window.clinicsData) {
                const clinic = window.clinicsData.find(c => c.id == clinicId);
                if (clinic) {
                    console.log('Loading clinic with fallback method:', clinic.name);
                    currentClinic = clinic;
                    updateClinicDisplay(clinic);
                } else {
                    showErrorMessage('Clinic not found');
                }
            } else if (!clinicId) {
                showErrorMessage('No clinic specified');
            } else {
                showErrorMessage('Unable to load clinic information');
            }
        }

        function loadClinicData(clinic) {
            // Basic clinic information
            document.getElementById('clinicName').textContent = clinic.name;
            document.getElementById('clinicType').textContent = formatType(clinic.type);
            document.getElementById('clinicAddress').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${clinic.address}`;
            document.getElementById('clinicPhone').textContent = clinic.phone;
            document.getElementById('clinicImage').src = CloudAssets.getClinicImage(clinic.image || clinic.logoUrl);
            document.getElementById('clinicImage').alt = clinic.name;
            
            // Update hero image (use clinic image or fallback to default)
            const heroImage = document.getElementById('clinicHeroImage');
            if (heroImage) {
                heroImage.src = CloudAssets.getClinicImage(clinic.image || clinic.logoUrl);
                heroImage.alt = `${clinic.name} - Interior View`;
            }
            
            // Generate unique description for each clinic
            const uniqueDescription = generateUniqueDescription(clinic);
            document.getElementById('clinicDescription').textContent = uniqueDescription;
            
            // Update overlay elements
            document.getElementById('overlayType').textContent = formatType(clinic.type);
            const typeIcon = getTypeIcon(clinic.type);
            document.querySelector('.type-badge i').className = typeIcon;
            
            // Show/hide premium badge based on clinic premium status
            const premiumBadge = document.getElementById('premiumBadge');
            const isPremium = clinic.premium || clinic.is_premium || clinic.premiumStatus;
            if (isPremium) {
                premiumBadge.style.display = 'block';
            } else {
                premiumBadge.style.display = 'none';
            }
            
            // Update rating display
            const stars = '★'.repeat(Math.floor(clinic.rating)) + (clinic.rating % 1 >= 0.5 ? '☆' : '');
            document.getElementById('clinicStars').textContent = stars;
            const reviewCount = clinic.reviews || clinic.reviewCount || clinic.review_count || 0;
            document.getElementById('clinicRating').textContent = `${clinic.rating} (${reviewCount} reviews)`;
            
            // Update contact information with timeout handling
            setTimeout(() => {
                // Update phone with timeout
                if (clinic.phone) {
                    document.getElementById('clinicPhone').textContent = clinic.phone;
                } else {
                    document.getElementById('clinicPhone').textContent = 'Not available';
                }
                
                // Update email with timeout
                const email = clinic.email || generateEmail(clinic);
                if (email && email !== 'Not available') {
                    document.getElementById('clinicEmail').textContent = email;
                } else {
                    document.getElementById('clinicEmail').textContent = 'Not available';
                }
                
                // Update status with timeout
                try {
                    const status = generateStatus(clinic);
                    const statusElement = document.getElementById('clinicStatus');
                    statusElement.textContent = status.text;
                    statusElement.className = status.class;
                } catch (error) {
                    document.getElementById('clinicStatus').textContent = 'Not available';
                }
            }, 2000); // 2 second timeout
            
            if (clinic.website) {
                document.getElementById('clinicWebsite').href = clinic.website;
                document.getElementById('clinicWebsite').style.display = 'inline-block';
            } else {
                document.getElementById('clinicWebsite').style.display = 'none';
            }
            
            // Update call button
            document.getElementById('clinicCallBtn').href = `tel:${clinic.phone}`;
            
            // Update mobile bottom action bar
            const bottomCallBtn = document.getElementById('bottomCallBtn');
            const bottomEmailBtn = document.getElementById('bottomEmailBtn');
            if (bottomCallBtn) bottomCallBtn.href = `tel:${clinic.phone}`;
            if (bottomEmailBtn) {
                const email = clinic.email || generateEmail(clinic);
                bottomEmailBtn.href = `mailto:${email}`;
            }
            
            // Update email
            const email = clinic.email || generateEmail(clinic);
            document.getElementById('clinicEmail').textContent = email;
            
            // Update status with real-time checking
            const status = generateStatus(clinic);
            const statusElement = document.getElementById('clinicStatus');
            statusElement.textContent = status.text;
            statusElement.className = status.class;
            // Update services
            const servicesContainer = document.getElementById('clinicServices');
            servicesContainer.innerHTML = '';
            const services = clinic.services || generateServices(clinic.type);
            services.forEach(service => {
                const serviceTag = document.createElement('span');
                serviceTag.className = 'service-tag';
                serviceTag.textContent = service;
                servicesContainer.appendChild(serviceTag);
            });
            
            // Update opening hours
            updateOpeningHours(clinic);
            
            // Setup button event listeners
            setupButtonListeners(clinic);
            
            // Load similar clinics
            loadSimilarClinics(clinic);
            
            // Update page title and SEO metadata
            updateSEOMetadata(clinic);
            
            // Setup auto-refresh for status (every minute)
            setupStatusAutoRefresh(clinic);
        }
        
        function updateSEOMetadata(clinic) {
            // Update page title
            const clinicTitle = `${clinic.name} - ${formatType(clinic.type)} in ${clinic.location || 'UK'} | CareGrid`;
            document.title = clinicTitle;
            document.getElementById('pageTitle').textContent = clinicTitle;
            
            // Update meta descriptions
            const description = `Book appointments at ${clinic.name}, a trusted ${formatType(clinic.type).toLowerCase()} in ${clinic.location || 'UK'}. View services, ratings, contact details and opening hours. ${clinic.rating ? `Rated ${clinic.rating}/5 stars.` : ''}`;
            document.getElementById('pageDescription').setAttribute('content', description);
            
            // Update Open Graph meta tags
            document.getElementById('ogTitle').setAttribute('content', clinicTitle);
            document.getElementById('ogDescription').setAttribute('content', description);
            if (clinic.image || clinic.logoUrl) {
                document.getElementById('ogImage').setAttribute('content', clinic.image || clinic.logoUrl);
            }
            
            // Update Twitter meta tags
            document.getElementById('twitterTitle').setAttribute('content', clinicTitle);
            document.getElementById('twitterDescription').setAttribute('content', description);
            if (clinic.image || clinic.logoUrl) {
                document.getElementById('twitterImage').setAttribute('content', clinic.image || clinic.logoUrl);
            }
            
            // Update JSON-LD schema
            updateClinicSchema(clinic);
        }
        
        function updateClinicSchema(clinic) {
            const schema = {
                "@context": "https://schema.org",
                "@type": "MedicalBusiness",
                "name": clinic.name,
                "description": generateUniqueDescription(clinic),
                "url": window.location.href,
                "telephone": clinic.phone,
                "address": {
                    "@type": "PostalAddress",
                    "streetAddress": clinic.address,
                    "addressLocality": clinic.location || "",
                    "addressRegion": "",
                    "postalCode": "",
                    "addressCountry": "GB"
                },
                "openingHours": [],
                "priceRange": "£",
                "aggregateRating": {
                    "@type": "AggregateRating",
                    "ratingValue": clinic.rating ? clinic.rating.toString() : "0",
                    "reviewCount": (clinic.reviews || clinic.reviewCount || clinic.review_count || 0).toString()
                },
                "image": clinic.image || clinic.logoUrl || "https://www.caregrid.co.uk/og-image.svg",
                "medicalSpecialty": [formatType(clinic.type)],
                "paymentAccepted": ["Cash", "Credit Card", "Bank Transfer"],
                "currenciesAccepted": "GBP"
            };
            
            // Add opening hours if available
            if (clinic.openingHours) {
                schema.openingHours = clinic.openingHours;
            }
            
            // Add website if available
            if (clinic.website) {
                schema.url = clinic.website;
            }
            
            // Update the schema script
            document.getElementById('clinicSchema').textContent = JSON.stringify(schema, null, 2);
        }
        
        function setupStatusAutoRefresh(clinic) {
            // Update status every minute
            setInterval(() => {
                const status = generateStatus(clinic);
                const statusElement = document.getElementById('clinicStatus');
                if (statusElement) {
                    statusElement.textContent = status.text;
                    statusElement.className = status.class;
                }
            }, 60000); // 60 seconds
        }
        
        function generateUniqueDescription(clinic) {
            const descriptions = {
                'GP': [
                    `${clinic.name} is a trusted general practice providing comprehensive primary healthcare services. Our experienced team of GPs offers personalized care in a welcoming environment, focusing on preventive medicine and patient wellbeing.`,
                    `At ${clinic.name}, we pride ourselves on delivering exceptional primary healthcare services. Our qualified general practitioners provide thorough consultations, health screenings, and ongoing care for patients of all ages.`,
                    `${clinic.name} offers modern general practice services with a patient-centered approach. Our dedicated medical team provides comprehensive healthcare solutions, from routine check-ups to chronic disease management.`
                ],
                'Private GP': [
                    `${clinic.name} provides premium private healthcare services with same-day appointments and extended consultation times. Our experienced doctors offer personalized medical care without the wait.`,
                    `Experience exceptional private healthcare at ${clinic.name}. We offer comprehensive medical services with flexible appointment times and dedicated attention to your health needs.`
                ],
                'Dentist': [
                    `${clinic.name} is a modern dental practice committed to providing excellent oral healthcare. Our skilled dentists use the latest techniques and technology to ensure comfortable, effective treatments.`,
                    `At ${clinic.name}, we believe in creating beautiful, healthy smiles. Our experienced dental team offers comprehensive oral care in a relaxed, professional environment.`,
                    `${clinic.name} combines advanced dental technology with compassionate care. Our qualified dentists provide a full range of treatments to maintain and improve your oral health.`
                ],
                'Private Dentist': [
                    `${clinic.name} offers premium private dental care with state-of-the-art facilities. Our expert dentists provide personalized treatment plans and the highest quality dental services.`,
                    `Experience luxury dental care at ${clinic.name}. We offer comprehensive private dental services with flexible scheduling and the latest in dental technology.`
                ],
                'Physio': [
                    `${clinic.name} specializes in physiotherapy and rehabilitation services. Our qualified physiotherapists help patients recover from injuries and improve their physical wellbeing through personalized treatment plans.`,
                    `At ${clinic.name}, we're dedicated to helping you move better and feel stronger. Our experienced physiotherapy team provides expert treatment for sports injuries, chronic pain, and rehabilitation.`,
                    `${clinic.name} offers comprehensive physiotherapy services using evidence-based treatments. Our skilled therapists work with you to achieve your recovery goals and optimize your physical health.`
                ],
                'Private Physiotherapy': [
                    `${clinic.name} provides premium physiotherapy services with one-on-one attention and flexible scheduling. Our expert therapists offer personalized treatment plans for optimal recovery.`,
                    `Experience exceptional physiotherapy care at ${clinic.name}. We offer private treatment sessions with advanced techniques and equipment for faster, more effective recovery.`
                ]
            };
            
            const typeDescriptions = descriptions[clinic.type] || descriptions['GP'];
            const randomIndex = Math.floor(Math.random() * typeDescriptions.length);
            return typeDescriptions[randomIndex];
        }
        
        function generateEmail(clinic) {
            const domain = clinic.name.toLowerCase().replace(/[^a-z0-9]/g, '') + '.co.uk';
            return `info@${domain}`;
        }
        
        function generateStatus(clinic) {
            return getRealtimeStatus(clinic);
        }
        
        function getRealtimeStatus(clinic) {
            const now = new Date();
            const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const currentTime = now.getHours() * 100 + now.getMinutes(); // e.g., 14:30 = 1430
            
            // Get opening hours for the clinic type
            const openingHours = generateOpeningHours(clinic.type);
            
            // Find today's hours
            let todayHours = null;
            
            for (const hour of openingHours) {
                if (isToday(hour.day, currentDay)) {
                    todayHours = hour;
                    break;
                }
            }
            
            if (!todayHours || todayHours.time === 'Closed') {
                return { text: 'Closed Today', class: 'status-closed' };
            }
            
            if (todayHours.time === 'By Appointment') {
                return { text: 'By Appointment', class: 'status-opening-soon' };
            }
            
            // Parse opening hours (e.g., "8:00 AM - 6:00 PM")
            const timeRange = parseTimeRange(todayHours.time);
            if (!timeRange) {
                return { text: 'Hours Unknown', class: 'status-opening-soon' };
            }
            
            const { openTime, closeTime } = timeRange;
            
            // Check if currently open
            if (currentTime >= openTime && currentTime < closeTime) {
                const closeHour = Math.floor(closeTime / 100);
                const closeMin = closeTime % 100;
                const closeTimeStr = formatTime12Hour(closeHour, closeMin);
                return { text: `Open - Closes ${closeTimeStr}`, class: 'status-open' };
            }
            
            // Check if opening soon (within next 2 hours)
            if (currentTime < openTime && (openTime - currentTime) <= 200) {
                const openHour = Math.floor(openTime / 100);
                const openMin = openTime % 100;
                const openTimeStr = formatTime12Hour(openHour, openMin);
                return { text: `Opens ${openTimeStr}`, class: 'status-opening-soon' };
            }
            
            // Otherwise closed
            if (currentTime < openTime) {
                const openHour = Math.floor(openTime / 100);
                const openMin = openTime % 100;
                const openTimeStr = formatTime12Hour(openHour, openMin);
                return { text: `Opens ${openTimeStr}`, class: 'status-closed' };
            } else {
                // Find tomorrow's opening time
                const tomorrowDay = (currentDay + 1) % 7;
                let tomorrowHours = null;
                
                for (const hour of openingHours) {
                    if (isToday(hour.day, tomorrowDay)) {
                        tomorrowHours = hour;
                        break;
                    }
                }
                
                if (tomorrowHours && tomorrowHours.time !== 'Closed') {
                    const tomorrowRange = parseTimeRange(tomorrowHours.time);
                    if (tomorrowRange) {
                        const openHour = Math.floor(tomorrowRange.openTime / 100);
                        const openMin = tomorrowRange.openTime % 100;
                        const openTimeStr = formatTime12Hour(openHour, openMin);
                        return { text: `Closed - Opens ${openTimeStr} Tomorrow`, class: 'status-closed' };
                    }
                }
                
                return { text: 'Closed', class: 'status-closed' };
            }
        }
        
        function isToday(dayString, currentDay) {
            const dayMap = {
                'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 
                'Friday': 5, 'Saturday': 6, 'Sunday': 0
            };
            
            // Handle ranges like "Monday - Friday"
            if (dayString.includes(' - ')) {
                const [startDay, endDay] = dayString.split(' - ');
                const startDayNum = dayMap[startDay.trim()];
                const endDayNum = dayMap[endDay.trim()];
                
                if (startDayNum <= endDayNum) {
                    return currentDay >= startDayNum && currentDay <= endDayNum;
                } else {
                    // Handle wrap-around (e.g., Friday - Monday)
                    return currentDay >= startDayNum || currentDay <= endDayNum;
                }
            }
            
            return dayMap[dayString] === currentDay;
        }
        
        function parseTimeRange(timeStr) {
            // Parse "8:00 AM - 6:00 PM" format
            const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)\s*-\s*(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return null;
            
            const [, openHour, openMin, openAmPm, closeHour, closeMin, closeAmPm] = match;
            
            const openTime24 = convertTo24Hour(parseInt(openHour), parseInt(openMin), openAmPm);
            const closeTime24 = convertTo24Hour(parseInt(closeHour), parseInt(closeMin), closeAmPm);
            
            return {
                openTime: openTime24,
                closeTime: closeTime24
            };
        }
        
        function convertTo24Hour(hour, minute, ampm) {
            let hour24 = hour;
            if (ampm.toUpperCase() === 'PM' && hour !== 12) {
                hour24 += 12;
            } else if (ampm.toUpperCase() === 'AM' && hour === 12) {
                hour24 = 0;
            }
            return hour24 * 100 + minute;
        }
        
        function formatTime12Hour(hour, minute) {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
            const displayMinute = minute.toString().padStart(2, '0');
            return `${displayHour}:${displayMinute} ${ampm}`;
        }
        
        function generateServices(type) {
            const serviceMap = {
                'GP': ['General Consultations', 'Health Screenings', 'Vaccinations', 'Minor Surgery'],
                'Private GP': ['Private Consultations', 'Executive Health Checks', 'Same-day Appointments', 'Specialist Referrals'],
                'Dentist': ['General Dentistry', 'Teeth Cleaning', 'Fillings', 'Oral Examinations'],
                'Private Dentist': ['Cosmetic Dentistry', 'Teeth Whitening', 'Dental Implants', 'Orthodontics'],
                'Physio': ['Manual Therapy', 'Exercise Therapy', 'Sports Rehabilitation', 'Pain Management'],
                'Private Physiotherapy': ['One-on-One Sessions', 'Sports Injury Treatment', 'Postural Assessment', 'Rehabilitation Programs']
            };
            return serviceMap[type] || serviceMap['GP'];
        }
        
        function updateOpeningHours(clinic) {
            const hoursContainer = document.getElementById('openingHours');
            const hours = generateOpeningHours(clinic.type);
            
            hoursContainer.innerHTML = '';
            hours.forEach(hour => {
                const hourRow = document.createElement('div');
                hourRow.className = 'hour-row';
                hourRow.innerHTML = `<span>${hour.day}</span><span>${hour.time}</span>`;
                hoursContainer.appendChild(hourRow);
            });
        }
        
        function generateOpeningHours(type) {
            const hourTemplates = {
                'GP': [
                    { day: 'Monday - Friday', time: '8:00 AM - 6:00 PM' },
                    { day: 'Saturday', time: '9:00 AM - 1:00 PM' },
                    { day: 'Sunday', time: 'Closed' }
                ],
                'Private GP': [
                    { day: 'Monday - Friday', time: '7:00 AM - 8:00 PM' },
                    { day: 'Saturday', time: '8:00 AM - 4:00 PM' },
                    { day: 'Sunday', time: '10:00 AM - 2:00 PM' }
                ],
                'Dentist': [
                    { day: 'Monday - Friday', time: '9:00 AM - 5:00 PM' },
                    { day: 'Saturday', time: '9:00 AM - 2:00 PM' },
                    { day: 'Sunday', time: 'Closed' }
                ],
                'Private Dentist': [
                    { day: 'Monday - Friday', time: '8:00 AM - 7:00 PM' },
                    { day: 'Saturday', time: '9:00 AM - 4:00 PM' },
                    { day: 'Sunday', time: 'By Appointment' }
                ],
                'Physio': [
                    { day: 'Monday - Friday', time: '8:00 AM - 7:00 PM' },
                    { day: 'Saturday', time: '9:00 AM - 3:00 PM' },
                    { day: 'Sunday', time: 'Closed' }
                ],
                'Private Physiotherapy': [
                    { day: 'Monday - Friday', time: '7:00 AM - 8:00 PM' },
                    { day: 'Saturday', time: '8:00 AM - 5:00 PM' },
                    { day: 'Sunday', time: '10:00 AM - 4:00 PM' }
                ]
            };
            
            return hourTemplates[type] || hourTemplates['GP'];
        }
        
        function setupButtonListeners(clinic) {
            // Book appointment button
            const bookingBtn = document.querySelector('.action-btn.primary');
            if (bookingBtn) {
                bookingBtn.addEventListener('click', function() {
                    window.location.href = `booking.html?clinicId=${clinic.id}`;
                });
            }
            
            // Get directions button
            const directionsBtn = document.getElementById('directionsBtn');
            if (directionsBtn) {
                directionsBtn.addEventListener('click', function() {
                    getDirections(clinic.address);
                });
            }
            
            // Share clinic button
            const shareBtn = document.querySelector('.action-btn.secondary[onclick*="shareClinic"]');
            if (shareBtn) {
                shareBtn.removeAttribute('onclick');
                shareBtn.addEventListener('click', function() {
                    shareClinic();
                });
            }
        }
        
        // Fix 5: Handle empty state for similar clinics
        function handleSimilarClinicsEmpty() {
            const list = document.getElementById('similar-list');
            const empty = document.getElementById('similar-empty');
            
            if (list && empty) {
                empty.hidden = false;
                list.innerHTML = '';
            }
        }
        
        function loadSimilarClinics(clinic) {
            const list = document.getElementById('similar-list');
            const empty = document.getElementById('similar-empty');
            
            if (!list || !empty || !window.clinicsData) return;
            
            // Find similar clinics (same type, different clinic, same city)
            let similarClinics = window.clinicsData
                .filter(c => c.id !== clinic.id && c.type === clinic.type && c.city === clinic.city)
                .slice(0, 3);
            
            if (similarClinics.length === 0) {
                // If no similar clinics in same city, find by type
                const altSimilar = window.clinicsData
                    .filter(c => c.id !== clinic.id && c.type === clinic.type)
                    .slice(0, 3);
                similarClinics = altSimilar;
            }
            
            if (similarClinics.length === 0) {
                // Show empty state if still no similar clinics found
                similarContainer.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-search" style="font-size: 48px; color: #ddd; margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 8px; color: #333;">No Similar Clinics Found</h3>
                        <p style="margin-bottom: 20px;">We couldn't find similar ${clinic.type || 'healthcare'} providers in your area.</p>
                        <a href="index.html" class="search-all-btn" style="display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; min-height: 44px; min-width: 44px; line-height: 20px;">
                            Search All Clinics
                        </a>
                    </div>
                `;
                return;
            }
            
            if (similarClinics.length === 0) {
                empty.hidden = false;
                list.innerHTML = '';
            } else {
                empty.hidden = true;
                list.innerHTML = similarClinics.map(renderClinicCard).join('');
            }
        }
        
        function renderClinicCard(clinic) {
            const stars = '★'.repeat(Math.floor(clinic.rating || 0));
            const reviewCount = clinic.reviews || clinic.reviewCount || clinic.review_count || 0;
            
            return `
                <div class="clinic-card" onclick="window.location.href='clinic-profile.html?id=${clinic.id}'">
                    <div class="clinic-image-container">
                        <img src="${clinic.image || clinic.logoUrl}" alt="${clinic.name}" class="clinic-image">
                        ${(clinic.premium || clinic.is_premium) ? '<div class="premium-badge-image"><i class="fas fa-crown"></i> Premium</div>' : ''}
                    </div>
                    <div class="clinic-content">
                        <h3 class="clinic-name">${clinic.name}</h3>
                        <p class="clinic-type">${formatType(clinic.type)}</p>
                        <p class="clinic-location">${clinic.address}</p>
                        <div class="clinic-rating">
                            <span class="stars">${stars}</span>
                            <span class="rating-text">${clinic.rating || 0} (${reviewCount} reviews)</span>
                        </div>
                    </div>
                </div>
            `;
        }


        function formatType(type) {
            const typeMap = {
                'gp': 'General Practitioner',
                'GP': 'General Practitioner',
                'Private GP': 'Private General Practitioner',
                'dentist': 'Dentist',
                'Dentist': 'Dentist',
                'Private Dentist': 'Private Dentist',
                'physio': 'Physiotherapist',
                'Physio': 'Physiotherapist',
                'Private Physiotherapy': 'Private Physiotherapy',
                'aesthetic': 'Aesthetic Clinic'
            };
            return typeMap[type] || type;
        }
        
        function getDirections(address) {
            const encodedAddress = encodeURIComponent(address);
            
            // Check if geolocation is available
            if ('geolocation' in navigator) {
                // Request user's current location
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        // Success: Got user's location
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        openMapsWithLocation(encodedAddress, userLat, userLng);
                    },
                    function(error) {
                        // Error or permission denied: Fall back to destination-only directions
                        console.log('Geolocation error:', error.message);
                        openMapsWithoutLocation(encodedAddress);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    }
                );
            } else {
                // Geolocation not supported: Fall back to destination-only directions
                openMapsWithoutLocation(encodedAddress);
            }
        }
        
        function openMapsWithLocation(encodedAddress, userLat, userLng) {
            // Check if user is on mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Try to open in native maps app with current location as start point
                const mapsUrl = `maps://maps.google.com/maps?saddr=${userLat},${userLng}&daddr=${encodedAddress}`;
                const googleMapsUrl = `https://maps.google.com/maps/dir/${userLat},${userLng}/${encodedAddress}`;
                
                // Try native app first, fallback to web
                window.location.href = mapsUrl;
                setTimeout(() => {
                    window.open(googleMapsUrl, '_blank');
                }, 500);
            } else {
                // Open Google Maps in new tab for desktop with directions from current location
                const googleMapsUrl = `https://maps.google.com/maps/dir/${userLat},${userLng}/${encodedAddress}`;
                window.open(googleMapsUrl, '_blank');
            }
        }
        
        function openMapsWithoutLocation(encodedAddress) {
            // Check if user is on mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Try to open in native maps app
                const mapsUrl = `maps://maps.google.com/maps?daddr=${encodedAddress}`;
                const googleMapsUrl = `https://maps.google.com/maps?daddr=${encodedAddress}`;
                
                // Try native app first, fallback to web
                window.location.href = mapsUrl;
                setTimeout(() => {
                    window.open(googleMapsUrl, '_blank');
                }, 500);
            } else {
                // Open Google Maps in new tab for desktop
                const googleMapsUrl = `https://maps.google.com/maps?daddr=${encodedAddress}`;
                window.open(googleMapsUrl, '_blank');
            }
        }
        
        function shareClinic() {
            const clinicName = currentClinic ? currentClinic.name : 'this clinic';
            const shareData = {
                title: `${clinicName} - CareGrid`,
                text: `Check out ${clinicName} on CareGrid`,
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare();
                });
            } else {
                fallbackShare();
            }
        }
        
        function fallbackShare() {
            const url = window.location.href;
            const clinicName = currentClinic ? currentClinic.name : 'this clinic';
            const text = `Check out ${clinicName} on CareGrid: ${url}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Clinic link copied to clipboard!');
                }).catch(() => {
                    promptShare(text);
                });
            } else {
                promptShare(text);
            }
        }
        
        function promptShare(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Clinic link copied to clipboard!');
            } catch (err) {
                alert('Please copy this link manually: ' + text);
            }
            document.body.removeChild(textArea);
        }
        
        function getTypeIcon(type) {
            const iconMap = {
                'gp': 'fas fa-user-md',
                'GP': 'fas fa-user-md',
                'Private GP': 'fas fa-user-md',
                'dentist': 'fas fa-tooth',
                'Dentist': 'fas fa-tooth',
                'Private Dentist': 'fas fa-tooth',
                'physio': 'fas fa-dumbbell',
                'Physio': 'fas fa-dumbbell',
                'Private Physiotherapy': 'fas fa-dumbbell',
                'aesthetic': 'fas fa-spa'
            };
            return iconMap[type] || 'fas fa-clinic-medical';
        }
        
        // Clinic type icon mapping function
        function getClinicTypeIcon(type) {
            const iconMap = {
                'medical': 'fas fa-user-md',
                'dental': 'fas fa-tooth',
                'physiotherapy': 'fas fa-dumbbell',
                'mental-health': 'fas fa-brain',
                'aesthetic': 'fas fa-spa'
            };
            return iconMap[type] || 'fas fa-clinic-medical';
        }
        
        function updateClinicDisplay(clinic) {
            // Update basic information
            const nameEl = document.getElementById('clinicName');
            if (nameEl) nameEl.textContent = clinic.name;
            
            const typeEl = document.getElementById('clinicType');
            if (typeEl) typeEl.textContent = clinic.type;
            
            const addressEl = document.getElementById('clinicAddress');
            if (addressEl) addressEl.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${clinic.address}`;
            
            const phoneEl = document.getElementById('clinicPhone');
            if (phoneEl) phoneEl.textContent = clinic.phone;
            
            const ratingEl = document.getElementById('clinicRating');
            if (ratingEl) ratingEl.textContent = `${clinic.rating} (${clinic.reviews || clinic.reviewCount || 0} reviews)`;
            
            const descEl = document.getElementById('clinicDescription');
            if (descEl) descEl.textContent = clinic.description || `${clinic.name} is a high-quality healthcare provider offering comprehensive medical services.`;
            
            const imageEl = document.getElementById('clinicImage');
            if (imageEl && clinic.image) imageEl.src = CloudAssets.getClinicImage(clinic.image);
            
            // Update call button
            const callBtn = document.getElementById('clinicCallBtn');
            if (callBtn && clinic.phone) callBtn.href = `tel:${clinic.phone}`;
            
            // Setup booking button
            const bookingBtn = document.querySelector('.action-btn.primary');
            if (bookingBtn) {
                bookingBtn.onclick = function() {
                    window.location.href = `booking.html?clinicId=${clinic.id}`;
                };
            }
            
            console.log('Clinic loading complete:', clinic.name);
        }
    </script>
    
    <!-- Clinic profile loading script with API support -->
    <script type="module">
        console.log('Starting clinic profile loading...');
        
        async function loadClinicProfile() {
            const urlParams = new URLSearchParams(window.location.search);
            const clinicId = urlParams.get('id');
            
            console.log('Looking for clinic ID:', clinicId);
            
            if (!clinicId) {
                console.error('No clinic ID provided');
                return false;
            }
            
            try {
                // Wait for API service to be available
                let attempts = 0;
                while (!window.apiService && attempts < 50) {
                    console.log('Waiting for API service...');
                    await new Promise(resolve => {
                        setTimeout(() => resolve(), 100);
                    });
                    attempts++;
                }
                
                console.log('Loading clinic from API...');
                
                // Try to get clinic from API first
                const response = await window.apiService.getClinics({ limit: 200 });
                const clinic = response.data.find(c => c.id == clinicId || c.frontendId == clinicId);
                
                if (clinic) {
                    console.log('Found clinic from API:', clinic.name);
                    updateClinicDisplay(clinic);
                    return true;
                } else {
                    console.log('Clinic not found in API, trying fallback data...');
                    return loadFromFallbackData(clinicId);
                }
            } catch (error) {
                console.error('Failed to load clinic data from API:', error);
                return loadFromFallbackData(clinicId);
            }
        }
        
        function loadFromFallbackData(clinicId) {
            if (window.clinicsData) {
                const clinic = window.clinicsData.find(c => c.id == clinicId);
                if (clinic) {
                    console.log('Found clinic in fallback data:', clinic.name);
                    updateClinicDisplay(clinic);
                    return true;
                }
            }
            console.log('Failed to load clinic profile');
            return false;
        }
        
        function updateClinicDisplay(clinic) {
            // Update basic information
            const elements = {
                'clinicName': clinic.name,
                'clinicType': formatType(clinic.type),
                'clinicAddress': `<i class="fas fa-map-marker-alt"></i> ${clinic.address}`,
                'clinicDescription': clinic.description || generateUniqueDescription(clinic)
            };
            
            for (const [id, content] of Object.entries(elements)) {
                const el = document.getElementById(id);
                if (el) {
                    if (id === 'clinicAddress') {
                        el.innerHTML = content;
                    } else {
                        el.textContent = content;
                    }
                }
            }

            // Update overlay elements
            const overlayType = document.getElementById('overlayType');
            if (overlayType) {
                overlayType.textContent = formatType(clinic.type);
            }
            
            const typeIcon = getTypeIcon(clinic.type);
            const typeBadgeIcon = document.querySelector('.type-badge i');
            if (typeBadgeIcon) {
                typeBadgeIcon.className = typeIcon;
            }

            // Show/hide premium badge
            const premiumBadge = document.getElementById('premiumBadge');
            const isPremium = clinic.premium || clinic.is_premium || clinic.premiumStatus;
            if (premiumBadge) {
                premiumBadge.style.display = isPremium ? 'block' : 'none';
            }

            // Update contact information (Fix 4: clears timeout fallback if data loads)
            const phoneEl = document.getElementById('clinicPhone');
            const emailEl = document.getElementById('clinicEmail');
            
            if (phoneEl) {
                phoneEl.textContent = clinic.phone || 'Not available';
            }
            
            if (emailEl) {
                const email = clinic.email || generateEmail(clinic);
                emailEl.textContent = email;
            }

            // Update status
            const status = generateStatus(clinic);
            const statusElement = document.getElementById('clinicStatus');
            if (statusElement) {
                statusElement.textContent = status.text;
                statusElement.className = status.class;
            }

            // Update services
            const servicesContainer = document.getElementById('clinicServices');
            if (servicesContainer) {
                servicesContainer.innerHTML = '';
                const services = clinic.services || generateServices(clinic.type);
                services.forEach(service => {
                    const serviceTag = document.createElement('span');
                    serviceTag.className = 'service-tag';
                    serviceTag.textContent = service;
                    servicesContainer.appendChild(serviceTag);
                });
            }

            // Update rating highlight row (Fix 3)
            const ratingHighlight = document.getElementById('ratingHighlight');
            const clinicStarsHighlight = document.getElementById('clinicStarsHighlight');
            const clinicRatingHighlight = document.getElementById('clinicRatingHighlight');
            
            if (ratingHighlight && clinicStarsHighlight && clinicRatingHighlight) {
                const stars = '★'.repeat(Math.floor(clinic.rating || 4.7));
                const reviewCount = clinic.reviews || clinic.reviewCount || clinic.review_count || 0;
                
                clinicStarsHighlight.textContent = stars;
                clinicRatingHighlight.textContent = `${clinic.rating || 4.7} • ${reviewCount} reviews`;
                ratingHighlight.style.display = 'flex';
            }
            
            // Update image
            const imageEl = document.getElementById('clinicImage');
            if (imageEl && (clinic.image || clinic.logoUrl)) {
                imageEl.src = CloudAssets.getClinicImage(clinic.image || clinic.logoUrl);
                imageEl.alt = clinic.name;
            }
            
            // Setup website button in Quick Actions (Fix 1)
            const websiteBtn = document.getElementById('websiteBtn');
            if (websiteBtn && clinic.website) {
                websiteBtn.onclick = function() {
                    window.open(clinic.website, '_blank');
                };
                websiteBtn.style.display = 'block';
            } else if (websiteBtn) {
                websiteBtn.style.display = 'none';
            }
            
            // Setup booking button in Quick Actions
            const bookingBtn = document.querySelector('.action-btn.primary');
            if (bookingBtn) {
                bookingBtn.onclick = function() {
                    window.location.href = `booking.html?clinicId=${clinic.id || clinic.frontendId}`;
                };
            }

            // Update opening hours
            updateOpeningHours(clinic);
            
            // Setup button event listeners
            setupButtonListeners(clinic);
            
            // Load similar clinics
            loadSimilarClinics(clinic);
            
            // Hide loading states
            const loadingElements = document.querySelectorAll('.loading-text');
            loadingElements.forEach(el => el.style.display = 'none');
            
            console.log('Clinic profile loaded successfully:', clinic.name);
        }
        
        // Try loading when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadClinicProfile);
        } else {
            loadClinicProfile();
        }
    </script>
    <script src="../js/config.js?v=2025082511"></script>
    <script type="module" src="../js/cloud-config.js"></script>
    <script type="module" src="../js/api-base.js?v=2025082511"></script>
    <script type="module" src="../js/api-service.js?v=2025082511"></script>
    <script type="module" src="../js/auth.js?v=2025082511"></script>
    <!-- Lazy Loading Script -->
    <script src="../js/lazy-loader.js"></script>
    <!-- Load clinic data from a dedicated file for profile page -->
    <script type="module" src="../js/clinic-data.js"></script>
    
    <script type="module" src="../js/header.js"></script>
    <script src="../js/ai-reception.js"></script>
<script src="../js/vapi-integration.js"></script>
    <script type="module">
        // Initialize default images when page loads
        import { CloudAssets } from '../js/cloud-config.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            // Set default logo
            const navLogo = document.getElementById('navLogo');
            if (navLogo) navLogo.src = CloudAssets.getLogo();
            
            // Set default hero image
            const heroImage = document.getElementById('clinicHeroImage');
            if (heroImage) heroImage.src = CloudAssets.getImageUrl('pall_mall_medical.jpg');
            
            // Set default clinic image placeholder
            const clinicImage = document.getElementById('clinicImage');
            if (clinicImage) clinicImage.src = CloudAssets.getClinicPlaceholder(1);
        });
    </script>
    <script>
        // Sticky CTA functionality - populate phone/email links
        document.addEventListener("DOMContentLoaded", async () => {
          try {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (!id) return;
            
            const res = await fetch(`${window.__API_BASE__ || 'https://caregrid-backend-latest.onrender.com'}/api/clinics?id=${id}`).catch(()=>null);
            const clinic = res ? await res.json() : {};
            const tel = document.querySelector("#cta-call");
            const eml = document.querySelector("#cta-email");
            if (clinic?.phone) tel.href = `tel:${clinic.phone}`;
            if (clinic?.email) eml.href = `mailto:${clinic.email}`;
          } catch(e){ console.warn("Sticky CTA fallback:", e); }
        });
    </script>
</body>
</html>