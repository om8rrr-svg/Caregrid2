<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareGrid API Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .timeout { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <h1>CareGrid Production Fixes Verification</h1>
    
    <div id="results"></div>
    
    <script src="js/api-service.js"></script>
    <script>
        const results = document.getElementById('results');
        
        function addResult(message, type) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }
        
        async function runTests() {
            addResult('Starting CareGrid production fixes verification...', 'info');
            
            // Test 1: buildUrl function
            try {
                const testUrl = apiService.buildUrl('/api/clinics', { limit: 5, city: 'London' });
                if (testUrl.includes('caregrid-backend.onrender.com') && testUrl.includes('limit=5') && testUrl.includes('city=London')) {
                    addResult('✅ buildUrl function working correctly', 'success');
                } else {
                    addResult('❌ buildUrl function not working correctly: ' + testUrl, 'error');
                }
            } catch (e) {
                addResult('❌ buildUrl function error: ' + e.message, 'error');
            }
            
            // Test 2: withTimeout function
            try {
                const timeoutTest = await apiService.withTimeout(
                    new Promise(resolve => setTimeout(() => resolve('success'), 1000)),
                    2000
                );
                addResult('✅ withTimeout function working correctly', 'success');
            } catch (e) {
                addResult('❌ withTimeout function error: ' + e.message, 'error');
            }
            
            // Test 3: Service worker unregistration
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length === 0) {
                    addResult('✅ Service workers properly unregistered', 'success');
                } else {
                    addResult('⚠️ Service workers still registered: ' + registrations.length, 'info');
                }
            } else {
                addResult('ℹ️ Service workers not supported in this environment', 'info');
            }
            
            // Test 4: API connection with timeout
            try {
                addResult('Testing API connection with timeout...', 'info');
                
                const clinics = await apiService.withTimeout(
                    apiService.getClinics({ limit: 1 }),
                    10000
                );
                
                if (clinics && (clinics.length > 0 || (clinics.data && clinics.data.length > 0))) {
                    addResult('✅ API connection successful with data', 'success');
                } else {
                    addResult('⚠️ API connection successful but no data returned', 'info');
                }
            } catch (e) {
                if (e.message === 'timeout') {
                    addResult('⚠️ API request timed out (expected if backend is sleeping)', 'timeout');
                } else {
                    addResult('⚠️ API connection failed: ' + e.message + ' (expected in demo mode)', 'info');
                }
            }
            
            addResult('Verification complete! Check results above.', 'info');
        }
        
        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>